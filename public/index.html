<!DOCTYPE html>
<html lang="tr">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>YZT Döner - Rezervasyon Yönetim Paneli</title>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
      * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
         background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ff6b35 100%);
         min-height: 100vh;
         color: #2c3e50;
      }

      .container {
         max-width: 1600px;
         margin: 0 auto;
         padding: 20px;
      }

      header {
         background: linear-gradient(135deg, #d35400, #e67e22);
         color: white;
         padding: 25px 30px;
         border-radius: 15px;
         box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
         margin-bottom: 25px;
         display: flex;
         justify-content: space-between;
         align-items: center;
      }

      .logo {
         display: flex;
         align-items: center;
         gap: 15px;
         font-size: 1.8rem;
         font-weight: 700;
      }

      .logo i {
         font-size: 2.2rem;
         color: #f39c12;
      }

      .status {
         display: flex;
         align-items: center;
         gap: 10px;
         background: rgba(255, 255, 255, 0.2);
         padding: 8px 15px;
         border-radius: 20px;
      }

      .status-dot {
         width: 12px;
         height: 12px;
         border-radius: 50%;
         background-color: #2ecc71;
         box-shadow: 0 0 10px #2ecc71;
         animation: pulse 2s infinite;
      }

      @keyframes pulse {
         0%, 100% { opacity: 1; }
         50% { opacity: 0.5; }
      }

      .stats-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
         gap: 20px;
         margin-bottom: 25px;
      }

      .stat-card {
         background: white;
         padding: 20px;
         border-radius: 15px;
         box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
         display: flex;
         align-items: center;
         gap: 15px;
         transition: transform 0.3s ease;
      }

      .stat-card:hover {
         transform: translateY(-3px);
      }

      .stat-icon {
         width: 50px;
         height: 50px;
         border-radius: 12px;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 1.5rem;
         color: white;
      }

      .stat-icon.orange { background: linear-gradient(135deg, #ff6b35, #f7931e); }
      .stat-icon.green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
      .stat-icon.blue { background: linear-gradient(135deg, #3498db, #2980b9); }
      .stat-icon.red { background: linear-gradient(135deg, #e74c3c, #c0392b); }

      .stat-info h3 {
         color: #7f8c8d;
         font-size: 0.9rem;
         font-weight: 500;
         margin-bottom: 5px;
      }

      .stat-info p {
         font-size: 1.8rem;
         font-weight: 700;
         color: #2c3e50;
      }

      .main-grid {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: 25px;
         margin-bottom: 25px;
      }

      .card {
         background: white;
         border-radius: 15px;
         box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
         padding: 25px;
         transition: transform 0.3s ease;
      }

      .card:hover {
         transform: translateY(-2px);
      }

      .card-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 20px;
         padding-bottom: 15px;
         border-bottom: 3px solid #f39c12;
      }

      .card-header h2 {
         color: #2c3e50;
         display: flex;
         align-items: center;
         gap: 10px;
         font-size: 1.3rem;
      }

      .refresh-btn {
         background: linear-gradient(135deg, #ff6b35, #f7931e);
         color: white;
         border: none;
         padding: 10px 20px;
         border-radius: 8px;
         cursor: pointer;
         transition: all 0.3s ease;
         display: flex;
         align-items: center;
         gap: 8px;
         font-weight: 600;
      }

      .refresh-btn:hover {
         transform: translateY(-2px);
         box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
      }

      .message-log {
         max-height: 400px;
         overflow-y: auto;
         border: 2px solid #ecf0f1;
         border-radius: 10px;
         padding: 15px;
      }

      .message-item {
         padding: 12px 15px;
         border-radius: 10px;
         margin-bottom: 10px;
         border-left: 4px solid;
         transition: all 0.3s ease;
      }

      .message-item:hover {
         transform: translateX(5px);
      }

      .message-item.incoming {
         background: linear-gradient(135deg, #e3f2fd, #bbdefb);
         border-color: #2196f3;
      }

      .message-item.outgoing {
         background: linear-gradient(135deg, #f1f8e9, #c8e6c9);
         border-color: #4caf50;
      }

      .message-header {
         display: flex;
         justify-content: space-between;
         margin-bottom: 8px;
         font-size: 0.85rem;
      }

      .message-user {
         font-weight: 600;
         color: #2c3e50;
      }

      .message-time {
         color: #7f8c8d;
      }

      .message-text {
         color: #34495e;
         line-height: 1.5;
      }

      table {
         width: 100%;
         border-collapse: collapse;
         border-radius: 10px;
         overflow: hidden;
         box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      th {
         background: linear-gradient(135deg, #ff6b35, #f7931e);
         color: white;
         padding: 15px 12px;
         text-align: left;
         font-weight: 600;
      }

      td {
         padding: 12px;
         border-bottom: 1px solid #ecf0f1;
         transition: background-color 0.3s ease;
      }

      tr:hover {
         background: #fff3e0;
      }

      .btn {
         padding: 8px 15px;
         border: none;
         border-radius: 6px;
         cursor: pointer;
         font-size: 0.9rem;
         transition: all 0.3s;
         display: inline-flex;
         align-items: center;
         gap: 5px;
         font-weight: 600;
      }

      .btn-danger {
         background: linear-gradient(135deg, #e74c3c, #c0392b);
         color: white;
      }

      .btn-danger:hover {
         transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
      }

      .hourly-calendar {
         max-height: 500px;
         overflow-y: auto;
         border: 2px solid #ecf0f1;
         border-radius: 10px;
         padding: 15px;
      }

      .calendar-grid {
         display: grid;
         grid-template-columns: 60px repeat(20, 1fr);
         gap: 2px;
         font-size: 0.8rem;
      }

      .calendar-header {
         background: linear-gradient(135deg, #ff6b35, #f7931e);
         color: white;
         padding: 10px 8px;
         text-align: center;
         font-weight: 600;
         border-radius: 5px;
      }

      .calendar-cell {
         padding: 8px 6px;
         text-align: center;
         border: 1px solid #dee2e6;
         border-radius: 4px;
         cursor: pointer;
         transition: all 0.2s;
         font-size: 0.7rem;
      }

      .calendar-cell.available {
         background: #e8f5e8;
         color: #2e7d32;
      }

      .calendar-cell.reserved {
         background: #ffebee;
         color: #c62828;
         cursor: not-allowed;
      }

      .calendar-cell:hover.available {
         background: #c8e6c9;
         transform: scale(1.05);
      }

      .empty-state {
         text-align: center;
         padding: 40px;
         color: #7f8c8d;
      }

      .empty-state i {
         font-size: 3rem;
         margin-bottom: 15px;
         opacity: 0.3;
      }

      .csv-editor {
         width: 100%;
         font-family: 'Courier New', monospace;
         padding: 15px;
         border: 2px solid #ecf0f1;
         border-radius: 10px;
         font-size: 0.9rem;
         line-height: 1.4;
         resize: vertical;
         min-height: 200px;
      }

      .csv-controls {
         display: flex;
         gap: 10px;
         align-items: center;
         margin-bottom: 15px;
         flex-wrap: wrap;
      }

      .csv-controls select {
         padding: 8px 12px;
         border: 2px solid #ecf0f1;
         border-radius: 8px;
         font-size: 1rem;
         background: white;
      }

      .csv-controls input[type="date"] {
         padding: 8px 12px;
         border: 2px solid #ecf0f1;
         border-radius: 8px;
         font-size: 1rem;
      }

      @media (max-width: 1200px) {
         .main-grid {
            grid-template-columns: 1fr;
         }
      }

      .loading {
         display: inline-block;
         width: 20px;
         height: 20px;
         border: 3px solid rgba(255, 107, 53, 0.3);
         border-radius: 50%;
         border-top-color: #ff6b35;
         animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
         to { transform: rotate(360deg); }
      }
   </style>
</head>
<body>
   <div class="container">
   <header>
           <div class="logo">
            <i class="fas fa-utensils"></i>
            YZT Döner - Rezervasyon Yönetimi
           </div>
         <div class="status">
            <div class="status-dot"></div>
            <span>Bot Aktif</span>
       </div>
   </header>

      <div class="stats-grid">
         <div class="stat-card">
            <div class="stat-icon orange">
               <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-info">
               <h3>Toplam Rezervasyon</h3>
               <p id="stat-reservations">0</p>
            </div>
         </div>

         <div class="stat-card">
            <div class="stat-icon green">
               <i class="fas fa-comments"></i>
            </div>
            <div class="stat-info">
               <h3>Toplam Mesaj</h3>
               <p id="stat-messages">0</p>
            </div>
         </div>

         <div class="stat-card">
            <div class="stat-icon blue">
               <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
               <h3>Aktif Kullanıcı</h3>
               <p id="stat-users">0</p>
            </div>
         </div>

         <div class="stat-card">
            <div class="stat-icon red">
               <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
               <h3>Bugünkü Rezervasyon</h3>
               <p id="stat-today">0</p>
            </div>
         </div>
           </div>

      <div class="main-grid">
         <div class="card">
            <div class="card-header">
               <h2><i class="fas fa-comment-dots"></i> Canlı Mesaj Logları</h2>
               <button class="refresh-btn" onclick="loadMessages()">
                  <i class="fas fa-sync-alt"></i> Yenile
               </button>
            </div>
            <div class="message-log" id="message-log">
               <div class="empty-state">
                  <i class="fas fa-inbox"></i>
                  <p>Henüz mesaj yok</p>
               </div>
            </div>
         </div>

         <div class="card">
            <div class="card-header">
               <h2><i class="fas fa-list"></i> Rezervasyonlar</h2>
               <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="date" id="date-filter" min="2025-10-24" max="2025-12-31" 
                         style="padding: 8px 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                  <button class="refresh-btn" onclick="filterByDate()">
                     <i class="fas fa-filter"></i> Filtrele
                  </button>
                  <button class="refresh-btn" onclick="loadReservations()">
                     <i class="fas fa-sync-alt"></i> Tümü
                  </button>
               </div>
            </div>
            <div style="overflow-x: auto;">
               <table id="reservations-table">
                  <thead>
                     <tr>
                        <th>Tarih</th>
                        <th>Saat</th>
                        <th>Masa</th>
                        <th>Müşteri</th>
                        <th>Kişi</th>
                        <th>İstekler</th>
                        <th>İşlem</th>
                     </tr>
                  </thead>
                  <tbody id="reservations-tbody">
                     <tr>
                        <td colspan="7" class="empty-state">Rezervasyon yükleniyor...</td>
                     </tr>
                  </tbody>
               </table>
            </div>
               </div>
           </div>

      <div class="card">
         <div class="card-header">
            <h2><i class="fas fa-calendar-alt"></i> Saatlik Rezervasyon Takvimi (12:00-23:00)</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
               <input type="date" id="calendar-date" min="2025-10-24" max="2025-12-31" 
                      style="padding: 8px 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
               <button class="refresh-btn" onclick="loadHourlyCalendar()">
                  <i class="fas fa-sync-alt"></i> Yenile
               </button>
            </div>
         </div>
         <div class="hourly-calendar" id="hourly-calendar">
            <div class="empty-state">
               <i class="fas fa-calendar"></i>
               <p>Takvim yükleniyor...</p>
            </div>
           </div>
       </div>

      <div class="card">
         <div class="card-header">
            <h2><i class="fas fa-file-csv"></i> CSV Veri Yönetimi</h2>
            <div class="csv-controls">
               <select id="csv-file-select">
                  <option value="reservations">reservations.csv</option>
                  <option value="tables">tables.csv</option>
                  <option value="weekly_menus">weekly_menus.csv</option>
                  <option value="weekly_occupancy">weekly_occupancy.csv</option>
               </select>
               <button class="refresh-btn" onclick="loadCsv()">
                  <i class="fas fa-download"></i> Yükle
               </button>
               <button class="refresh-btn" onclick="saveCsv()">
                  <i class="fas fa-save"></i> Kaydet
               </button>
            </div>
           </div>
         <textarea id="csv-editor" class="csv-editor" placeholder="CSV içerik burada görünecek..."></textarea>
         <div style="margin-top: 10px; color: #7f8c8d; font-size: 0.9rem;">
            💡 Not: Kaydettiğinizde ilgili dosya anında yenilenir ve bot tarafından kullanılmaya başlar.
           </div>
           </div>
       </div>

<script>
   // Load stats
   async function loadStats() {
      try {
         const res = await fetch('/api/stats');
         const data = await res.json();
         document.getElementById('stat-reservations').textContent = data.totalReservations;
         document.getElementById('stat-messages').textContent = data.totalMessages;
         document.getElementById('stat-users').textContent = data.activeUsers;
         
         // Bugünkü rezervasyon sayısı
         const today = new Date().toISOString().split('T')[0];
         const reservationsRes = await fetch('/api/reservations');
         const reservations = await reservationsRes.json();
         const todayReservations = reservations.filter(r => r.date === today).length;
         document.getElementById('stat-today').textContent = todayReservations;
      } catch (err) {
         console.error('Stats error:', err);
      }
   }

   // Load messages
   async function loadMessages() {
      try {
         const res = await fetch('/api/messages');
         const messages = await res.json();
         const container = document.getElementById('message-log');
         
         if (messages.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Henüz mesaj yok</p></div>';
            return;
         }

         container.innerHTML = messages.map(msg => `
            <div class="message-item ${msg.type}">
               <div class="message-header">
                  <span class="message-user">
                     <i class="fas fa-user"></i> ${msg.userName} (ID: ${msg.userId})
                  </span>
                  <span class="message-time">${new Date(msg.timestamp).toLocaleString('tr-TR')}</span>
               </div>
               <div class="message-text">${msg.message}</div>
            </div>
         `).join('');
      } catch (err) {
         console.error('Messages error:', err);
      }
   }

   // Load reservations
   async function loadReservations() {
      try {
         const res = await fetch('/api/reservations');
         const reservations = await res.json();
         const tbody = document.getElementById('reservations-tbody');
         
         if (reservations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Henüz rezervasyon yok</td></tr>';
            return;
         }

         tbody.innerHTML = reservations.map(r => `
            <tr>
               <td>${r.date}</td>
               <td>${r.time}</td>
               <td>Masa ${r.table_number}</td>
               <td>${r.customer_name}</td>
               <td>${r.party_size}</td>
               <td>${r.special_requests || '-'}</td>
               <td>
                  <button class="btn btn-danger" onclick="cancelReservation('${r.date}', '${r.time}', ${r.table_number})">
                     <i class="fas fa-times"></i> İptal
                  </button>
               </td>
            </tr>
         `).join('');
      } catch (err) {
         console.error('Reservations error:', err);
      }
   }

   // Filter reservations by date
   async function filterByDate() {
      const dateInput = document.getElementById('date-filter').value;
      if (!dateInput) {
         alert('Lütfen bir tarih seçin!');
         return;
      }

      try {
         const res = await fetch('/api/reservations');
         const allReservations = await res.json();
         const filtered = allReservations.filter(r => r.date === dateInput);
         
         const tbody = document.getElementById('reservations-tbody');
         
         if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Bu tarihte rezervasyon yok</td></tr>';
            return;
         }

         tbody.innerHTML = filtered.map(r => `
            <tr>
               <td>${r.date}</td>
               <td>${r.time}</td>
               <td>Masa ${r.table_number}</td>
               <td>${r.customer_name}</td>
               <td>${r.party_size}</td>
               <td>${r.special_requests || '-'}</td>
               <td>
                  <button class="btn btn-danger" onclick="cancelReservation('${r.date}', '${r.time}', ${r.table_number})">
                     <i class="fas fa-times"></i> İptal
                  </button>
               </td>
            </tr>
         `).join('');
      } catch (err) {
         console.error('Filter error:', err);
      }
   }

   // Load hourly calendar
   async function loadHourlyCalendar() {
      try {
         const dateInput = document.getElementById('calendar-date');
         const selectedDate = dateInput.value || new Date().toISOString().split('T')[0];
         
         const res = await fetch('/api/reservations');
         const reservations = await res.json();
         
         const dayReservations = reservations.filter(r => r.date === selectedDate);
         
         const hours = [];
         for (let h = 12; h <= 23; h++) {
            hours.push(h.toString().padStart(2, '0') + ':00');
         }

         const container = document.getElementById('hourly-calendar');
         
         container.innerHTML = `
            <div class="calendar-grid">
               <div class="calendar-header">Saat</div>
               ${Array.from({length: 20}, (_, i) => 
                  `<div class="calendar-header">Masa ${i+1}</div>`
               ).join('')}
               
               ${hours.map(hour => {
                  const hourReservations = dayReservations.filter(r => r.time === hour);
                  const reservedTables = hourReservations.map(r => parseInt(r.table_number));
                  
                  return `
                     <div class="calendar-header">${hour}</div>
                     ${Array.from({length: 20}, (_, i) => {
                        const tableNum = i + 1;
                        const isReserved = reservedTables.includes(tableNum);
                        const reservation = hourReservations.find(r => parseInt(r.table_number) === tableNum);
                        
                        return `
                           <div class="calendar-cell ${isReserved ? 'reserved' : 'available'}" 
                                title="${isReserved ? 
                                   `Rezerve: ${reservation.customer_name} (${reservation.party_size} kişi)` : 
                                   'Müsait'
                                }"
                                onclick="${isReserved ? '' : `selectTable('${selectedDate}', '${hour}', ${tableNum})`}">
                              ${isReserved ? '❌' : '✅'}
                           </div>
                        `;
                     }).join('')}
                  `;
               }).join('')}
            </div>
         `;

      } catch (err) {
         console.error('Hourly calendar error:', err);
         const container = document.getElementById('hourly-calendar');
         container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Takvim yüklenemedi</p></div>';
      }
   }

   function selectTable(date, time, tableNumber) {
      const customerName = prompt('Müşteri adı:');
      const partySize = prompt('Kişi sayısı:');
      const specialRequests = prompt('Özel istekler (boş bırakabilirsiniz):') || 'Yok';
      
      if (customerName && partySize) {
         alert(`Rezervasyon: ${date} ${time} - Masa ${tableNumber} - ${customerName} (${partySize} kişi)`);
         loadHourlyCalendar();
      }
   }

   // Cancel reservation
   async function cancelReservation(date, time, tableNumber) {
      if (!confirm(`${date} ${time} tarihli Masa ${tableNumber} rezervasyonunu iptal etmek istediğinize emin misiniz?`)) {
         return;
      }

      try {
         const res = await fetch('/api/reservation/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date, time, tableNumber })
         });
         const result = await res.json();
         
         if (result.success) {
            alert('✅ Rezervasyon iptal edildi!');
            loadReservations();
            loadHourlyCalendar();
            loadStats();
         } else {
            alert('❌ Hata: ' + result.message);
         }
      } catch (err) {
         alert('❌ Bağlantı hatası');
      }
   }

   // CSV Editor functions
   async function loadCsv() {
      const file = document.getElementById('csv-file-select').value;
      const res = await fetch(`/api/csv?file=${encodeURIComponent(file)}`);
      if (!res.ok) {
         document.getElementById('csv-editor').value = 'Dosya okunamadı';
         return;
      }
      const text = await res.text();
      document.getElementById('csv-editor').value = text;
   }

   async function saveCsv() {
      const file = document.getElementById('csv-file-select').value;
      const content = document.getElementById('csv-editor').value;
      const res = await fetch(`/api/csv?file=${encodeURIComponent(file)}`, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ content })
      });
      if (res.ok) {
         alert('✅ Kaydedildi');
         if (file === 'reservations') { 
            loadReservations(); 
            loadHourlyCalendar(); 
         }
      } else {
         alert('❌ Kaydedilemedi');
      }
   }

   // Auto refresh every 5 seconds
   setInterval(() => {
      loadStats();
      loadMessages();
      loadReservations();
      loadHourlyCalendar();
   }, 5000);

   // Initial load
   window.onload = () => {
      loadStats();
      loadMessages();
      loadReservations();
      loadHourlyCalendar();
      loadCsv();
      
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date-filter').value = today;
      document.getElementById('calendar-date').value = today;
   };
</script>

</body>
</html>